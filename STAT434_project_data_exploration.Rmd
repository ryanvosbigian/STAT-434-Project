---
title: "STAT434 Project Data Exploration"
author: "Emma Barton and Ryan Vosbigian"
date: "5/21/2020"
output: html_document
---

# Questions for Ryan
How do we want to group the redlist categories - specifically should we group endangered with extinct, extinct in the wild, and critically endangered?

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE)

```

# Set Up

```{r load packages}

library(tidyverse)

```

```{r set pathway}

## Local Pathways - copy/paste your local pathway to the github repository

# Emma
pathway = "/Users/emmabarton/Desktop/spring_2020/STAT434/project/"

# Ryan
#pathway = "~/GitHub/STAT-434---not-the-dodo-/"

```

```{r load data}

mammal_df = read.csv("cleaned_mammal_df.csv")
bird_df = read.csv("cleaned_bird_df_updated_5_29.csv")

```

# Data Exploration

Elton traits: diet, foraging strata, foraging time, and body size. 

## Mammals

```{r variables}

names(mammal_df)

```
Diet variables are the estimated percent use of Inv: invertebrates Vend: mammals and birds, Vect: reptiles, snakes, amphibians, salamanders, Vfish: fish, Vunk: general vertebrates or unknown, Scav: scavenge, garbage, offal, carcasses, trawlers, carrion, Fruit: fruit and drupes, Nect: nector, pollen, plant exudates, gums, Seed: seed, maize, nuts, spores, wheat, grains, Plant: other plant material. All diet categories should add to 100%.

Diet source is a reference ID and diet certainty is the estimated reliability of the diet sources (see metadata for rankings).

ForStrat.Value: One of five foraging stratum categories (marine, ground, scansorial, arboreal, aerial).

Activity variables are binary 0:no, 1:yes. Nocturnal: night, Crepuscular: twilight, Diurnal: day. 

Bodymass.Value: average adult body mass (g)

Redlist Category: Critically Endangered, Data Deficient, Endangered, Extinct, Extinct in the Wild, Least Concern, Near Threatened, Vulnerable

### Single Variable Distributions

```{r mammal single variable tables}

# Response: Redlist Category
table(mammal_df$redlistCategory)

# Body Mass distribution
mammal_df %>% 
  mutate(
    bodymass_bin = case_when(
      BodyMass.Value >= 100000 ~ ">=100,000",
      BodyMass.Value < 100000 & BodyMass.Value >= 10000 ~ "10,000 - 100,000",
      BodyMass.Value < 10000 & BodyMass.Value >= 1000 ~ "10,000 - 1,000",
      BodyMass.Value < 1000 & BodyMass.Value >= 100 ~ "1,000 - 100",
      BodyMass.Value < 100 ~ "<100"
     )
  ) %>% 
  group_by(bodymass_bin) %>% 
  dplyr::summarize(n = n())

```
The majority of species in our dataset are of least concern, followed by data deficient and vulnurable. However, combining critically endangered, endangered, extinct, and extinct in the wild results in 626 species.

The majority of mammals have a bodymass less than 100g followed by a bodymass between 1069. There are some mammals with a bodymass orders of magnitude greater than 100,000g. 

```{r mammal single variable graphs}

# Body Mass Histogram
ggplot(mammal_df, aes(BodyMass.Value)) + 
  geom_histogram(binwidth = 25000000) + 
  theme_classic()

# Log Transformed Body Mass Histogram
ggplot(mammal_df, aes(BodyMass.Value)) + 
  geom_histogram() + 
  scale_x_continuous(trans = "log") +
  theme_classic()

```
Because of the large disparity between large mammals with a much greater body mass than 100,000 and the majority of mammals, the distribution of bodymass is very skewed right. 

### Pairwise Relationships

```{r mammal explanatory vs response tables}

# Redlist Category vs Population Trend
table(mammal_df$redlistCategory, mammal_df$populationTrend)

# Redlist Category vs Foraging Stratum 
prop.table(table(mammal_df$redlistCategory,mammal_df$ForStrat.Value),2)*100 #makes a nice looking table with % by column

```

```{r mammal explanatory vs response graphs}

# 1
# Population Trend and Redlist Category Bar Plot
mammal_df %>% 
  mutate(
    redlistCat2 = case_when(
      redlistCategory == "Critically Endangered" ~ "Endangered or Extinct",
      redlistCategory == "Endangered" ~ "Endangered or Extinct",
      redlistCategory == "Extinct" ~ "Endangered or Extinct",
      redlistCategory == "Extinct in the Wild" ~ "Endangered or Extinct",
      TRUE ~ as.character(redlistCategory)
    )
  ) %>% 
  ggplot(aes(populationTrend)) +
    geom_bar(col = "black") +
    facet_wrap(~redlistCat2) +
    coord_flip() +
    theme_classic()

# 2
# Redlist Category vs Body Mass Value Box Plot
mammal_df %>% 
  mutate(
    redlistCat2 = case_when(
      redlistCategory == "Critically Endangered" ~ "Endangered or Extinct",
      redlistCategory == "Endangered" ~ "Endangered or Extinct",
      redlistCategory == "Extinct" ~ "Endangered or Extinct",
      redlistCategory == "Extinct in the Wild" ~ "Endangered or Extinct",
      TRUE ~ as.character(redlistCategory)
    )
  ) %>% 
  ggplot(aes(redlistCat2, BodyMass.Value)) +
    geom_boxplot() +
    coord_flip() +
    scale_y_continuous(trans = "log") +
    theme_classic()

# 3 
# Average Diet Percent Use vs Redlist Category Barplots
mammal_df %>% 
  mutate(
    redlistCat2 = case_when(
      redlistCategory == "Critically Endangered" ~ "Endangered or Extinct",
      redlistCategory == "Endangered" ~ "Endangered or Extinct",
      redlistCategory == "Extinct" ~ "Endangered or Extinct",
      redlistCategory == "Extinct in the Wild" ~ "Endangered or Extinct",
      TRUE ~ as.character(redlistCategory)
    )
  ) %>% 
  gather(key = "diet_type", value = "percentage", Diet.Inv, Diet.Vend, 
         Diet.Vect, Diet.Vfish, Diet.Vunk, Diet.Scav, Diet.Fruit, Diet.Nect,
         Diet.Seed, Diet.PlantO) %>% 
  ggplot(aes(diet_type, percentage)) +
    stat_summary(geom = "bar", fun = mean, position = position_dodge(), 
                 colour = "black", fill = "white",
                 width = 0.7) +
    stat_summary(geom = "errorbar", fun.data = mean_se, 
                 position = position_dodge(0.7),
                 width = 0.25) +
    facet_wrap(~redlistCat2) +
    coord_flip() +
    theme_classic()

# 4
# Foraging Stratum and Redlist Category Bar Plot
mammal_df %>% 
  mutate(
    redlistCat2 = case_when(
      redlistCategory == "Critically Endangered" ~ "Endangered or Extinct",
      redlistCategory == "Endangered" ~ "Endangered or Extinct",
      redlistCategory == "Extinct" ~ "Endangered or Extinct",
      redlistCategory == "Extinct in the Wild" ~ "Endangered or Extinct",
      TRUE ~ as.character(redlistCategory)
    )
  ) %>% 
  ggplot(aes(ForStrat.Value)) +
    geom_bar(col = "black") +
    facet_wrap(~redlistCat2) +
    theme_classic()

```
1) The majority of endangered or extinct mammals (critically endangered, endangered, extinct, and extinct in the wild grouped into one category) have a decreasing population trend. The majority of vulnerable and near threatened mammals also have a decreasing population trend. The majority of least concern mammals have either a stable population trend or an unknown population trend. 

It is very likely that the redlist category of a mammal is designated based on population trend knowledge. Many of the mammals in the least concern category may actually be more threatened than believed becasue their population trend is unknown.  

2) Natural log transformed body mass value (g) vs redlist category. There are visually no major differences in body mass distributions between categories other than mammals categorized as least concern and data deficient seem to have more outliers with large body mass values. 

3) Average percent use of each diet category for each redlist category. Averages appear similar across redlist categories. 

4) Distribution of foraging stratum divided by redlist category. Mammals that are of least concern have a higher proportion of ground foragers. Other than this there are appear to be no major differences between the categories.      

```{r mammal explanatory vs explanatory graphs}

# 5
# Average Percent Use of Each Diet Type
mammal_df %>% 
  gather(key = "diet_type", value = "percentage", Diet.Inv, Diet.Vend, 
         Diet.Vect, Diet.Vfish, Diet.Vunk, Diet.Scav, Diet.Fruit, Diet.Nect,
         Diet.Seed, Diet.PlantO) %>% 
  ggplot(aes(diet_type, percentage)) + 
    stat_summary(geom = "bar", fun = mean, position = position_dodge(), 
                 colour = "black", fill = "white",
                 width = 0.7) +
    stat_summary(geom = "errorbar", fun.data = mean_se, 
                 position = position_dodge(0.7),
                 width = 0.25) +
    coord_flip() + 
    theme_classic()

# 6 
# Activity vs Body Mass Boxplot
mammal_df %>%
  gather(key = "activity_type", value = "value", Activity.Nocturnal, 
         Activity.Crepuscular, Activity.Diurnal) %>% 
  filter(value == 1) %>% 
  ggplot(aes(activity_type, BodyMass.Value)) +
    geom_boxplot() +
    scale_y_continuous(trans = "log") +
    coord_flip() +
    theme_classic()

```
5) Invertebrates were the diet component with the highest average percent use, followed by other plant parts and fruit.

6) Average body mass value for each activity type. Diurnal and Crepuscular have slightly larger median bodymass values. 

## Birds 

```{r variables}

names(bird_df)

```
Diet variables are the estimated percent use of Inv: invertebrates Vend: mammals and birds, Vect: reptiles, snakes, amphibians, salamanders, Vfish: fish, Vunk: general vertebrates or unknown, Scav: scavenge, garbage, offal, carcasses, trawlers, carrion, Fruit: fruit and drupes, Nect: nector, pollen, plant exudates, gums, Seed: seed, maize, nuts, spores, wheat, grains, Plant: other plant material. All diet categories should add to 100%.

Diet.5Cat: assignment to one of five diet categories (PlantSeed, FruiNect, Invertebrate, VertFishScav, Omnivore)

Foraging stratum variables are the estimated percent use of watbelowsurf: below water surface, wataroundsurf: on water surface, ground: ground, understory: below 2m in understory, midhigh: higher than 2m but below canopy, canopy: canopy, aerial: well above tree structures. All foraging stratum categories should add to 100%. 

PelagicSpecialist: binary variable for foraging being mostly pelagic.

Nocturnal: binary variable for night foraging

Bodymass.Value: average adult body mass (g)

Redlist Category: Critically Endangered, Data Deficient, Endangered, Extinct, Extinct in the Wild, Least Concern, Near Threatened, Vulnerable

### Single Variable Distributions

```{r}

```

### Pairwise Relationships

```{r}

```


```{r investigate birds}

prop.table(table(bird_df$redlistCategory))*100

prop.table(table(bird_df$redlistCategory,bird_df$populationTrend),2)*100

prop.table(table(bird_df$redlistCategory,bird_df$Diet.Inv),2)*100

prop.table(table(bird_df$redlistCategory,bird_df$Diet.Nect),2)*100

prop.table(table(bird_df$redlistCategory,bird_df$Nocturnal),2)*100

prop.table(table(bird_df$redlistCategory,bird_df$PelagicSpecialist),2)*100

#Deciding which ones to include based on whether different redlistcategories have different percentages in each percentage of variable 

prop.table(table(bird_df$redlistCategory,bird_df$ForStrat.watbelowsurf),2)*100 #include in model

prop.table(table(bird_df$redlistCategory,bird_df$ForStrat.wataroundsurf),2)*100 # include in model
 
prop.table(table(bird_df$redlistCategory,bird_df$ForStrat.ground),2)*100 #even across all categories so not including in model

prop.table(table(bird_df$redlistCategory,bird_df$ForStrat.understory),2)*100 #pretty even across categories, not including

prop.table(table(bird_df$redlistCategory,bird_df$ForStrat.midhigh),2)*100 #pretty even across categories, not including

prop.table(table(bird_df$redlistCategory,bird_df$ForStrat.canopy),2)*100 # moderately even

prop.table(table(bird_df$redlistCategory,bird_df$ForStrat.aerial),2)*100 #very high proportion in least concern, including

sapply(split(bird_df$BodyMass.Value,bird_df$redlistCategory),mean)
sapply(split(bird_df$BodyMass.Value,bird_df$redlistCategory),length)

```

# Descriptive Statistics
